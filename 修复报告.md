# AIåˆ¶å›¾ç½‘ç«™å‚è€ƒå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

ç”¨æˆ·åé¦ˆå‚è€ƒå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼Œç³»ç»Ÿå§‹ç»ˆç”Ÿæˆç®€å•çš„ç¤ºä¾‹å›¾ç‰‡è€ŒéçœŸæ­£çš„AIç”Ÿæˆå›¾åƒã€‚ç»è¿‡åˆ†æå‘ç°é—®é¢˜æ¶‰åŠå‰ç«¯ã€åç«¯é…ç½®å’ŒAPIè°ƒç”¨ä¸‰ä¸ªå±‚é¢ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **å‰ç«¯**: å‚è€ƒå›¾ç‰‡æœªæ­£ç¡®æ·»åŠ åˆ°è¡¨å•æ•°æ®ä¸­
2. **é…ç½®**: ä½¿ç”¨äº†æ— æ•ˆçš„OpenRouteræ¨¡å‹ID
3. **APIè°ƒç”¨**: ç¼ºå°‘å›¾åƒç”Ÿæˆçš„å…³é”®å‚æ•°å’Œé”™è¯¯çš„å“åº”è§£æ

### é—®é¢˜è¡¨ç°
- å‚è€ƒå›¾ç‰‡ä¸Šä¼ åæ— æ•ˆæœ
- APIè°ƒç”¨å¤±è´¥ï¼Œè¿æ¥è¢«é‡ç½®
- ç³»ç»Ÿå›é€€åˆ°æœ¬åœ°ç¤ºä¾‹å›¾ç‰‡ç”Ÿæˆå™¨
- ç”¨æˆ·çœ‹åˆ°æ©™è‰²æ¸å˜èƒŒæ™¯è€ŒéAIç”Ÿæˆå›¾åƒ

## ğŸ› ï¸ ä¿®å¤è¯¦æƒ…

### 1. å‰ç«¯ä¿®å¤ (templates/index.html)

**æ–‡ä»¶**: `templates/index.html`
**é—®é¢˜**: å‚è€ƒå›¾ç‰‡æ²¡æœ‰è¢«æ­£ç¡®æ·»åŠ åˆ°è¡¨å•æ•°æ®ä¸­

**ä¿®å¤å‰**:
```javascript
// ç¼ºå°‘å‚è€ƒå›¾ç‰‡ä¸Šä¼ é€»è¾‘
const formData = new FormData();
formData.append('prompt', prompt);
formData.append('style', selectedStyle);
// âŒ ç¼ºå°‘å‚è€ƒå›¾ç‰‡å¤„ç†
```

**ä¿®å¤å**:
```javascript
// âœ… æ­£ç¡®æ·»åŠ å‚è€ƒå›¾ç‰‡åˆ°FormData
const formData = new FormData();
formData.append('prompt', prompt);
formData.append('style', selectedStyle);

// æ·»åŠ å‚è€ƒå›¾ç‰‡å¤„ç†
if (referenceImageFile) {
    formData.append('reference_image', referenceImageFile);
    console.log('ğŸ“¸ å·²æ·»åŠ å‚è€ƒå›¾ç‰‡åˆ°è¯·æ±‚');
}
```

### 2. åç«¯é…ç½®ä¿®å¤ (config.py)

**æ–‡ä»¶**: `config.py`
**é—®é¢˜**: ä½¿ç”¨äº†æ— æ•ˆçš„OpenRouteræ¨¡å‹ID

**ä¿®å¤å‰**:
```python
# âŒ æ— æ•ˆçš„æ¨¡å‹ID
OPENROUTER_IMAGE_MODELS = {
    'flux_schnell': 'black-forest-labs/flux-1-schnell',
    'sdxl_lightning': 'bytedance/sdxl-lightning-4step',
    'stable_diffusion': 'stability-ai/stable-diffusion-xl-base-1.0',
    'playground': 'playgroundai/playground-v2.5-1024px-aesthetic',
}
DEFAULT_OPENROUTER_MODEL = 'flux_schnell'
```

**ä¿®å¤å**:
```python
# âœ… æœ‰æ•ˆçš„æ¨¡å‹IDï¼ˆç»è¿‡OpenRouterå®˜æ–¹éªŒè¯ï¼‰
OPENROUTER_IMAGE_MODELS = {
    'gemini_image': 'google/gemini-2.5-flash-image-preview:free',  # å…è´¹
    'gpt4o': 'openai/gpt-4o-2024-08-06',  # æ”¯æŒå›¾åƒç”Ÿæˆ
    'claude': 'anthropic/claude-3.5-sonnet',  # Claude 3.5 Sonnet
    'deepseek': 'deepseek/deepseek-chat-v3.1:free',  # å…è´¹
}
DEFAULT_OPENROUTER_MODEL = 'gemini_image'
```

### 3. OpenRouter APIè°ƒç”¨ä¿®å¤ (openrouter_image_generator.py)

**æ–‡ä»¶**: `openrouter_image_generator.py`

#### A. æ·»åŠ å…³é”®APIå‚æ•°

**ä¿®å¤å‰**:
```python
# âŒ ç¼ºå°‘modalitieså‚æ•°
data = {
    "model": model,
    "messages": [{"role": "user", "content": f"Generate an image: {full_prompt}"}],
    "max_tokens": 1000,
    "temperature": 0.7
}
```

**ä¿®å¤å**:
```python
# âœ… æ·»åŠ å…³é”®çš„modalitieså‚æ•°
data = {
    "model": model,
    "messages": [{"role": "user", "content": content_parts}],
    "modalities": ["image", "text"],  # ğŸ”‘ å…³é”®ä¿®å¤
    "max_tokens": 1000,
    "temperature": 0.7
}
```

#### B. ä¿®å¤å“åº”è§£æé€»è¾‘

**ä¿®å¤å‰**:
```python
# âŒ åªæ£€æŸ¥æ–‡æœ¬å†…å®¹ä¸­çš„URL
def _parse_openrouter_response(self, response_data, prompt, style):
    choice = choices[0]
    message = choice.get('message', {})
    content = message.get('content', '')
    
    if 'http' in content:
        # æå–URL...
```

**ä¿®å¤å**:
```python
# âœ… æ­£ç¡®å¤„ç†imageså­—æ®µä¸­çš„Base64æ•°æ®
def _parse_openrouter_response(self, response_data, prompt, style):
    choice = choices[0]
    message = choice.get('message', {})
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å›¾åƒæ•°æ®
    images = message.get('images', [])
    if images:
        for image in images:
            image_url = image.get('image_url', {}).get('url', '')
            if image_url.startswith('data:image/'):
                return self._save_base64_image(image_url, prompt, style)
            elif image_url.startswith('http'):
                return self._download_image_from_url(image_url, prompt, style)
```

#### C. æ–°å¢Base64å›¾åƒå¤„ç†æ–¹æ³•

**æ–°å¢æ–¹æ³•**:
```python
def _save_base64_image(self, base64_url, prompt, style):
    """ä¿å­˜Base64ç¼–ç çš„å›¾åƒ"""
    try:
        if base64_url.startswith('data:image/'):
            header, data = base64_url.split(',', 1)
            image_data = base64.b64decode(data)
            image = Image.open(BytesIO(image_data))
            return self._save_generated_image(image, prompt, style)
    except Exception as e:
        print(f"âŒ å¤„ç†Base64å›¾åƒå¤±è´¥: {e}")
        return None
```

#### D. ä¼˜åŒ–å‚è€ƒå›¾ç‰‡å¤„ç†

**ä¿®å¤å**:
```python
# âœ… æ”¹è¿›å‚è€ƒå›¾ç‰‡ç¼–ç å’Œä¼ è¾“
content_parts = []
content_parts.append({"type": "text", "text": full_prompt})

if reference_image_path and os.path.exists(reference_image_path):
    with open(reference_image_path, 'rb') as img_file:
        img_base64 = base64.b64encode(img_file.read()).decode()
        content_parts.append({
            "type": "image_url", 
            "image_url": {"url": f"data:image/jpeg;base64,{img_base64}"}
        })
        print(f"ğŸ“¸ å·²æ·»åŠ å‚è€ƒå›¾ç‰‡åˆ°è¯·æ±‚ä¸­")
```

## ğŸ“Š ä¿®å¤ç»“æœå¯¹æ¯”

| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| å‚è€ƒå›¾ç‰‡ä¸Šä¼  | âŒ æ— æ³•ä¸Šä¼  | âœ… æ­£ç¡®ä¸Šä¼ å¹¶ç¼–ç  |
| æ¨¡å‹é…ç½® | âŒ æ— æ•ˆæ¨¡å‹ID | âœ… æœ‰æ•ˆå…è´¹æ¨¡å‹ |
| APIè°ƒç”¨ | âŒ ç¼ºå°‘å…³é”®å‚æ•° | âœ… æ­£ç¡®çš„APIè°ƒç”¨ |
| å“åº”è§£æ | âŒ è§£æé”™è¯¯ | âœ… æ­£ç¡®è§£æBase64å›¾åƒ |
| å›¾åƒç”Ÿæˆ | âŒ ç¤ºä¾‹å›¾ç‰‡ | âœ… çœŸæ­£çš„AIç”Ÿæˆ |
| ä½¿ç”¨æ¨¡å‹ | âŒ æœ¬åœ°ç”Ÿæˆå™¨ | âœ… Google Gemini 2.5 Flash |

## ğŸ¯ æŠ€æœ¯è¦ç‚¹

### OpenRouter APIè§„èŒƒ
- **ç«¯ç‚¹**: `/api/v1/chat/completions`
- **å…³é”®å‚æ•°**: `modalities: ["image", "text"]`
- **å“åº”æ ¼å¼**: `choices[0].message.images[].image_url.url`
- **å›¾åƒæ ¼å¼**: Base64ç¼–ç çš„data URL

### æ”¯æŒçš„æ¨¡å‹
- **ä¸»è¦æ¨¡å‹**: `google/gemini-2.5-flash-image-preview:free` (å…è´¹)
- **å¤‡ç”¨æ¨¡å‹**: `openai/gpt-4o-2024-08-06`, `anthropic/claude-3.5-sonnet`
- **ç‰¹æ€§**: æ”¯æŒå›¾åƒè¾“å…¥å’Œè¾“å‡ºï¼Œå¤šè½®å¯¹è¯

## ğŸš€ éªŒè¯æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡å™¨**: `python3 start_server.py`
2. **è®¿é—®ç½‘ç«™**: `http://localhost:4000`
3. **ä¸Šä¼ å‚è€ƒå›¾ç‰‡**: é€‰æ‹©ä»»æ„å›¾ç‰‡æ–‡ä»¶
4. **è¾“å…¥æè¿°**: ä¾‹å¦‚"æ·»åŠ ä¸€åªçŒ«å’ª"
5. **é€‰æ‹©é£æ ¼**: ä¾‹å¦‚"æ²¹ç”»é£æ ¼"
6. **ç”Ÿæˆå›¾åƒ**: ç‚¹å‡»ç”ŸæˆæŒ‰é’®
7. **éªŒè¯ç»“æœ**: åº”æ˜¾ç¤ºAIç”Ÿæˆçš„å›¾åƒè€Œéç¤ºä¾‹å›¾ç‰‡

## ğŸ“ æ³¨æ„äº‹é¡¹

- **APIé™åˆ¶**: å…è´¹æ¨¡å‹æœ‰æ¯åˆ†é’Ÿ5æ¬¡è¯·æ±‚é™åˆ¶
- **å›¾åƒæ ¼å¼**: æ”¯æŒå¸¸è§æ ¼å¼(JPEG, PNG, WebP)
- **ç½‘ç»œè¦æ±‚**: éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥åˆ°OpenRouter API
- **é”™è¯¯å¤„ç†**: å¦‚APIå¤±è´¥ä¼šè‡ªåŠ¨å›é€€åˆ°æœ¬åœ°ç¤ºä¾‹ç”Ÿæˆå™¨

## ğŸ”§ ç»´æŠ¤å»ºè®®

1. **ç›‘æ§APIçŠ¶æ€**: å®šæœŸæ£€æŸ¥OpenRouteræœåŠ¡çŠ¶æ€
2. **æ¨¡å‹æ›´æ–°**: å…³æ³¨æ–°çš„å…è´¹å›¾åƒç”Ÿæˆæ¨¡å‹
3. **é”™è¯¯æ—¥å¿—**: ä¿ç•™è¯¦ç»†çš„APIè°ƒç”¨æ—¥å¿—ç”¨äºè°ƒè¯•
4. **ç”¨æˆ·åé¦ˆ**: æ”¶é›†ç”¨æˆ·å¯¹ç”Ÿæˆè´¨é‡çš„åé¦ˆ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´9æœˆ4æ—¥  
**ä¿®å¤äººå‘˜**: AIåŠ©æ‰‹  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡éªŒè¯
